WITH 
WITH MATERIALS_ID AS (
	SELECT DICTINCT
	*
	FROM (
		SELECT 
		  max(МатериалыРБМ.id) AS id, 
		  МатериалыРБМ.НазваниеМтрПоГостОстТу AS НазваниеРБМ, 
		  '#' || МатериалыРБМ.НазваниеМтрПоГостОстТу || '#' || МатериалыРБМ.КодМтрПоСпецификацииИндексЧертеж || '#' AS Измерение, 
		  'РФ' AS СтранаИзготовитель,
		  ПоставщикиМатериаловРБМ.ПоставвщикИсх AS Поставщик, 
		  ПоставщикиМатериаловРБМ.Поставвщик.id AS ПоставвщикID 
		FROM Справочники.МатериалыРБМ AS МатериалыРБМ 
		LEFT JOIN Справочники.ПоставщикиМатериаловРБМ AS ПоставщикиМатериаловРБМ 
		  ON ПоставщикиМатериаловРБМ.УуидРодительскойЗаписи = МатериалыРБМ.uuid
		GROUP BY НазваниеРБМ, Измерение, СтранаИзготовитель, Поставщик, ПоставвщикID
		
		UNION

		SELECT 
		  MATERIALS_ID.id AS id, 
		  МатериалыРБМИмпорт.НазваниеМтрПоГостОстТу AS НазваниеРБМ, 
		  '#' || МатериалыРБМИмпорт.НазваниеМтрПоГостОстТу || '#' || МатериалыРБМИмпорт.КодМтрПоСпецификацииИндексЧертеж || '#' AS Измерение, 
		  ПоставщикиМатериаловРбмИмпорт.СтранаИзготовителяИсх AS СтранаИзготовитель, 
		  ПоставщикиМатериаловРбмИмпорт.НазваниеИзготовителяПоставщика AS Поставщик, 
		  0 AS ПоставвщикID 
		FROM Справочники.РесурсыРБМИмпорт AS МатериалыРБМИмпорт 
		LEFT JOIN Справочники.ПоставщикиМатериаловРбмИмпорт AS ПоставщикиМатериаловРбмИмпорт 
		  ON ПоставщикиМатериаловРбмИмпорт.УуидРодительскойЗаписи = МатериалыРБМИмпорт.uuid 
		GROUP BY НазваниеРБМ, Измерение, СтранаИзготовитель, Поставщик, ПоставвщикID
	) AS distinct_id
)


MATERIALS AS (
	SELECT 
	  MATERIALS_ID.id AS id, 
	  МатериалыРБМ.НазваниеМтрПоГостОстТу AS НазваниеРБМ, 
	  '#' || МатериалыРБМ.НазваниеМтрПоГостОстТу || '#' || МатериалыРБМ.КодМтрПоСпецификацииИндексЧертеж || '#' AS Измерение, 
	  'РФ' AS СтранаИзготовитель,
	  ПоставщикиМатериаловРБМ.ПоставвщикИсх AS Поставщик, 
	  ПоставщикиМатериаловРБМ.Поставвщик.id AS ПоставвщикID 
	FROM Справочники.МатериалыРБМ AS МатериалыРБМ 
	LEFT JOIN Справочники.ПоставщикиМатериаловРБМ AS ПоставщикиМатериаловРБМ 
	  ON ПоставщикиМатериаловРБМ.УуидРодительскойЗаписи = МатериалыРБМ.uuid 
	LEFT JOIN MATERIALS_ID
	 -- условия джоина можно заменить, главное, чтобы присоединить уникальные значения прост
	  ON  MATERIALS_ID.НазваниеРБМ = МатериалыРБМ.НазваниеМтрПоГостОстТу
	 and MATERIALS_ID.Измерение = '#' || МатериалыРБМ.НазваниеМтрПоГостОстТу || '#' || МатериалыРБМ.КодМтрПоСпецификацииИндексЧертеж || '#'
	 and MATERIALS_ID.СтранаИзготовитель = 'РФ'
	 and MATERIALS_ID.Поставщик = ПоставщикиМатериаловРБМ.ПоставвщикИсх
	 and MATERIALS_ID.ПоставвщикID = ПоставщикиМатериаловРБМ.Поставвщик.id


	UNION 
	 
	SELECT 
	  MATERIALS_ID.id AS id, 
	  МатериалыРБМИмпорт.НазваниеМтрПоГостОстТу AS НазваниеРБМ, 
	  '#' || МатериалыРБМИмпорт.НазваниеМтрПоГостОстТу || '#' || МатериалыРБМИмпорт.КодМтрПоСпецификацииИндексЧертеж || '#' AS Измерение, 
	  ПоставщикиМатериаловРбмИмпорт.СтранаИзготовителяИсх AS СтранаИзготовитель, 
	  ПоставщикиМатериаловРбмИмпорт.НазваниеИзготовителяПоставщика AS Поставщик, 
	  0 AS ПоставвщикID 
	FROM Справочники.РесурсыРБМИмпорт AS МатериалыРБМИмпорт 
	LEFT JOIN Справочники.ПоставщикиМатериаловРбмИмпорт AS ПоставщикиМатериаловРбмИмпорт 
	  ON ПоставщикиМатериаловРбмИмпорт.УуидРодительскойЗаписи = МатериалыРБМИмпорт.uuid 
	LEFT JOIN MATERIALS_ID
	 -- условия джоина можно заменить, главное, чтобы присоединить уникальные значения прост
	  ON  MATERIALS_ID.НазваниеРБМ = МатериалыРБМИмпорт.НазваниеМтрПоГостОстТу
	 and MATERIALS_ID.Измерение = '#' || МатериалыРБМИмпорт.НазваниеМтрПоГостОстТу || '#' || МатериалыРБМИмпорт.КодМтрПоСпецификацииИндексЧертеж || '#'
	 and MATERIALS_ID.СтранаИзготовитель = ПоставщикиМатериаловРбмИмпорт.СтранаИзготовителяИсх
	 and MATERIALS_ID.Поставщик = ПоставщикиМатериаловРБМ.ПоставвщикИсх
	 and MATERIALS_ID.ПоставвщикID = 0

	ORDER BY НазваниеРБМ)


 
SELECT DISTINCT
  MATERIALS.id AS id, 
  MATERIALS.НазваниеРБМ AS НазваниеРБМ, 
  MATERIALS.Измерение AS Измерение, 
  MATERIALS.Поставщик AS Поставщик, 
  Расчеты.РезультатРасчетов AS РезультатРасчетов, 
  Расчеты.Теги AS Теги 
FROM MATERIALS AS MATERIALS 
LEFT JOIN Справочники.Расчеты.РезультатыРасчетов AS Расчеты 
  ON MATERIALS.Измерение = Расчеты.Теги 
WHERE 
Расчеты.Ссылка.Аббревиатура = 'ВХОЖДЕНИЕ-МТР-В-ФИ'
